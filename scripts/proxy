#!/bin/bash

set -e

if [[ -n "$DEBUG" ]]; then
  set -xe
fi

ssh_escape() {
  for arg; do
    printf '%q ' "$arg"
  done
}

if [[ -n "$SSH_TARGET_HOST" ]]; then
  echo "Using remote mode!"
  exec ./scripts/ssh \
    "export" "GITLAB_RAILS_REVISION=$GITLAB_RAILS_REVISION" "&&" \
    "export" "GITLAB_WORKHORSE_REVISION=$GITLAB_WORKHORSE_REVISION" "&&" \
    "export" "GITLAB_GITALY_REVISION=$GITLAB_GITALY_REVISION" "&&" \
    "export" "GITLAB_PAGES_REVISION=$GITLAB_PAGES_REVISION" "&&" \
    "export" "GITLAB_SHELL_REVISION=$GITLAB_SHELL_REVISION" "&&" \
    "export" "COMPOSE_KIT_REVISION=$COMPOSE_KIT_REVISION" "&&" \
    "export" "CUSTOM_HOSTNAME=${CUSTOM_HOSTNAME:-$SSH_TARGET_HOST}" "&&" \
    "export" "CUSTOM_WEB_PORT=$CUSTOM_WEB_PORT" "&&" \
    "export" "CUSTOM_SSH_PORT=$CUSTOM_SSH_PORT" "&&" \
    "export" "CUSTOM_REGISTRY_PORT=$CUSTOM_REGISTRY_PORT" "&&" \
    "export" "USE_WEB_SERVER=$USE_WEB_SERVER" "&&" \
    "export" "USE_RAILS=$USE_RAILS" "&&" \
    "export" "USE_DB=$USE_DB" "&&" \
    "export" "ENABLE_SPRING=$ENABLE_SPRING" "&&" \
    "export" "USE_WEBPACK_DEV=$USE_WEBPACK_DEV" "&&" \
    "export" "USE_TRACING=$USE_TRACING" "&&" \
    "export" "COMPOSE_HTTP_TIMEOUT=$COMPOSE_HTTP_TIMEOUT" "&&" \
    "export" "METRICS_TOKEN=$METRICS_TOKEN" "&&" \
    "mkdir" "-p" "$SSH_TARGET_DIR" "&&" \
    "cd" "$SSH_TARGET_DIR" "&&" \
    ./scripts/proxy $(ssh_escape "$@")
fi

if [[ -z "$CUSTOM_HOSTNAME" ]]; then
  case "$(uname -s)" in
    Linux)
      export CUSTOM_HOSTNAME=$(hostname -I | cut -d' ' -f1)
      ;;

    Darwin)
      export CUSTOM_HOSTNAME=$(ipconfig getifaddr en0 || ipconfig getifaddr en1 || ipconfig getifaddr en2 || ipconfig getifaddr en3)
      ;;
  esac
fi

if [[ -z "$CUSTOM_HOSTNAME" ]]; then
  echo "Could not detect IP address. Consider setting this as an environment variable:"
  echo "use export CUSTOM_HOSTNAME=<my-ip-address>"
  echo "use export CUSTOM_HOSTNAME=<dns-hostname>"
  echo "You can put it in .env file!"
  exit 1
fi

export CUSTOM_CONFIG=$(cat gitlab.yml)
export CUSTOM_UID=$(id -u)
export CUSTOM_GID=$(id -g)

exec "$@"
